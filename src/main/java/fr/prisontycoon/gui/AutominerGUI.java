package fr.prisontycoon.gui;

import fr.prisontycoon.PrisonTycoon;
import fr.prisontycoon.data.MineData;
import fr.prisontycoon.data.PlayerData;
import fr.prisontycoon.utils.HeadEnum;
import fr.prisontycoon.utils.HeadUtils;
import fr.prisontycoon.utils.NumberFormatter;
import org.bukkit.Material;
import org.bukkit.Sound;
import org.bukkit.entity.Player;
import org.bukkit.event.inventory.ClickType;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.ItemMeta;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Objects;

/**
 * Interface graphique principale du syst√®me d'automineur
 */
public class AutominerGUI {

    private final PrisonTycoon plugin;

    public AutominerGUI(PrisonTycoon plugin) {
        this.plugin = plugin;
    }

    /**
     * Ouvre le menu principal des automineurs
     */
    public void openMainMenu(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        Inventory inv = plugin.getGUIManager().createInventory(27, "¬ß8Menu Automineurs");
        plugin.getGUIManager().registerOpenGUI(player, GUIType.AUTOMINER_MAIN, inv);

        // Slots des automineurs actifs
        ItemStack slot1 = playerData.getActiveAutominerSlot1();
        ItemStack slot2 = playerData.getActiveAutominerSlot2();

        // Slot 1
        inv.setItem(10, Objects.requireNonNullElseGet(slot1, () -> createEmptySlotItem("¬ß7Slot 1 - Vide", "¬ßeCliquez avec un automineur", "¬ßepour l'activer!")));

        // Slot 2
        inv.setItem(16, Objects.requireNonNullElseGet(slot2, () -> createEmptySlotItem("¬ß7Slot 2 - Vide", "¬ßeCliquez avec un automineur", "¬ßepour l'activer!")));

        // Item Monde
        inv.setItem(12, createWorldItem(playerData));

        // Item Stockage
        inv.setItem(13, createStorageItem(playerData));

        // Item Carburant
        inv.setItem(14, createFuelItem(playerData));

        // Item Condensation
        inv.setItem(22, createCondensationItem());

        // Items d√©coratifs
        fillEmptySlots(inv);

        player.openInventory(inv);
    }

    /**
     * G√®re les clics dans le menu principal
     */
    public void handleMainMenuClick(Player player, int slot, ItemStack clickedItem, ClickType clickType) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        switch (slot) {
            case 10: // Slot 1
                handleAutominerSlotClick(player, playerData, 1, clickType);
                break;
            case 16: // Slot 2
                handleAutominerSlotClick(player, playerData, 2, clickType);
                break;
            case 12: // Monde
                handleWorldClick(player, playerData, clickType);
                break;
            case 13: // Stockage
                if (clickType == ClickType.LEFT) {
                    plugin.getAutominerCondHeadGUI().openStorageMenu(player);
                }
                break;
            case 14: // Carburant
                if (clickType == ClickType.LEFT) {
                    plugin.getAutominerCondHeadGUI().openFuelMenu(player);
                }
                break;
            case 22: // Condensation
                if (clickType == ClickType.LEFT) {
                    plugin.getAutominerCondHeadGUI().openCondensationMenu(player);
                }
                break;
        }
    }

    /**
     * G√®re l'interaction avec les items d'automineur depuis l'inventaire du joueur
     */
    public void handleInventoryItemClick(Player player, ItemStack item) {
        if (!plugin.getAutominerManager().isAutominer(item)) {
            return;
        }

        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        // Trouver le premier slot disponible
        if (playerData.getActiveAutominerSlot1() == null) {
            playerData.setActiveAutominerSlot1(item.clone());
            item.setAmount(0); // Retire l'item de l'inventaire
            player.sendMessage("¬ßa‚úì Automineur plac√© dans le slot 1!");
        } else if (playerData.getActiveAutominerSlot2() == null) {
            playerData.setActiveAutominerSlot2(item.clone());
            item.setAmount(0);
            player.sendMessage("¬ßa‚úì Automineur plac√© dans le slot 2!");
        } else {
            player.sendMessage("¬ßcTous les slots d'automineur sont occup√©s!");
            return;
        }

        plugin.getPlayerDataManager().markDirty(player.getUniqueId());
        openMainMenu(player); // Rafra√Æchir le menu

        player.playSound(player.getLocation(), Sound.ENTITY_EXPERIENCE_ORB_PICKUP, 1.0f, 1.0f);
    }

    // ==================== M√âTHODES PRIV√âES ====================

    private void handleAutominerSlotClick(Player player, PlayerData playerData, int slotNumber, ClickType clickType) {
        ItemStack currentAutominer = (slotNumber == 1) ?
                playerData.getActiveAutominerSlot1() :
                playerData.getActiveAutominerSlot2();

        if (currentAutominer == null) {
            player.sendMessage("¬ßcAucun automineur dans ce slot!");
            return;
        }

        if (clickType == ClickType.LEFT) {
            // Ouvrir le menu d'am√©lioration
            plugin.getAutominerEnchantGUI().openEnchantMenu(player, currentAutominer, slotNumber);
        } else if (clickType == ClickType.SHIFT_LEFT) {
            // Retirer l'automineur
            if (player.getInventory().firstEmpty() == -1) {
                player.sendMessage("¬ßcVotre inventaire est plein!");
                return;
            }

            player.getInventory().addItem(currentAutominer);

            if (slotNumber == 1) {
                playerData.setActiveAutominerSlot1(null);
            } else {
                playerData.setActiveAutominerSlot2(null);
            }

            plugin.getPlayerDataManager().markDirty(player.getUniqueId());
            player.sendMessage("¬ßa‚úì Automineur retir√© du slot " + slotNumber + "!");
            player.playSound(player.getLocation(), Sound.ENTITY_ITEM_PICKUP, 1.0f, 1.0f);

            openMainMenu(player); // Rafra√Æchir le menu
        }
    }

    private void handleWorldClick(Player player, PlayerData playerData, ClickType clickType) {
        if (clickType == ClickType.SHIFT_LEFT) {
            // G√©n√©rer un nouveau monde al√©atoire
            String currentWorld = playerData.getAutominerCurrentWorld();
            String newWorld = generateRandomWorld(currentWorld);

            long beaconCost = calculateWorldChangeCost();
            if (playerData.getBeacons() < beaconCost) {
                player.sendMessage("¬ßcVous n'avez pas assez de beacons! Co√ªt: " + beaconCost);
                return;
            }

            playerData.removeBeacon(beaconCost);
            playerData.setAutominerCurrentWorld(newWorld);

            plugin.getPlayerDataManager().markDirty(player.getUniqueId());

            player.sendMessage("¬ßa‚úì Nouveau monde de minage: " + newWorld.toUpperCase());
            player.sendMessage("¬ß7Co√ªt: " + beaconCost + " beacons");
            player.playSound(player.getLocation(), Sound.ENTITY_ENDERMAN_TELEPORT, 1.0f, 1.0f);

            openMainMenu(player); // Rafra√Æchir le menu
        }
    }

    private ItemStack createEmptySlotItem(String name, String... lore) {
        ItemStack item = new ItemStack(Material.GRAY_STAINED_GLASS_PANE);
        ItemMeta meta = item.getItemMeta();
        plugin.getGUIManager().applyName(meta, name);
        if (lore.length > 0) plugin.getGUIManager().applyLore(meta, List.of(lore));
        item.setItemMeta(meta);
        return item;
    }

    private ItemStack createWorldItem(PlayerData playerData) {
        ItemStack item = HeadUtils.createHead(HeadEnum.GLOBE);
        ItemMeta meta = item.getItemMeta();

        String currentWorld = playerData.getAutominerCurrentWorld();
        if (currentWorld == null) {
            currentWorld = "mine-a";
            playerData.setAutominerCurrentWorld(currentWorld);
        }

        plugin.getGUIManager().applyName(meta, "¬ß2üåç Monde de Minage");
        List<String> lore = new ArrayList<>();
        lore.add("¬ß7Monde actuel: ¬ßf" + currentWorld.toUpperCase());
        lore.add("");

        // Afficher la composition des blocs
        MineData mineData = plugin.getConfigManager().getMineData(currentWorld);
        if (mineData != null) {
            lore.add("¬ß7Composition des blocs:");
            for (Map.Entry<Material, Double> entry : mineData.getBlockComposition().entrySet()) {
                String materialName = formatMaterialName(entry.getKey());
                double percentage = entry.getValue() * 100;

                // === CORRECTION : Obtenir le prix de vente avec nouvelle logique ===
                long sellPrice = plugin.getConfigManager().getSellPrice(entry.getKey());
                long blockCoins = 0;
                long blockTokens = 0;

                var blockValue = plugin.getConfigManager().getBlockValue(entry.getKey());
                if (blockValue != null) {
                    blockCoins = blockValue.coins();
                    blockTokens = blockValue.tokens();
                }

                String priceText = "";
                if (sellPrice > 0) {
                    priceText = " ¬ß7(¬ßa" + NumberFormatter.format(sellPrice) + "¬ß7$)";
                } else if (blockCoins > 0) {
                    priceText = " ¬ß7(¬ßa" + NumberFormatter.format(blockCoins) + "¬ß7$)";
                } else if (blockTokens > 0) {
                    priceText = " ¬ß7(¬ße" + NumberFormatter.format(blockTokens) + "¬ß7T)";
                } else {
                    // Utiliser prix par d√©faut
                    long defaultPrice = getDefaultPrice(entry.getKey());
                    if (defaultPrice > 0) {
                        priceText = " ¬ß7(¬ßa" + NumberFormatter.format(defaultPrice) + "¬ß7$)";
                    }
                }

                lore.add("¬ß8‚Ä¢ ¬ßf" + materialName + ": ¬ße" + String.format("%.1f%%", percentage) + priceText);
            }
        }

        lore.add("");
        lore.add("¬ßeShift+Clic: ¬ß7Changer de monde");
        lore.add("¬ß7Co√ªt: ¬ße" + calculateWorldChangeCost() + " beacons");

        plugin.getGUIManager().applyLore(meta, lore);
        item.setItemMeta(meta);
        return item;
    }

    private ItemStack createStorageItem(PlayerData playerData) {
        ItemStack item = HeadUtils.createHead(HeadEnum.CHEST_GUI);
        ItemMeta meta = item.getItemMeta();

        plugin.getGUIManager().applyName(meta, "¬ß6üì¶ Stockage");
        List<String> lore = new ArrayList<>();

        Map<Material, Long> storage = playerData.getAutominerStorageContents();
        long totalStored = storage.values().stream().mapToLong(Long::longValue).sum();
        long maxCapacity = 1000L + (playerData.getAutominerStorageLevel() * 500L);

        lore.add("¬ß7Capacit√©: ¬ßf" + NumberFormatter.format(totalStored) + "¬ß7/¬ßf" + NumberFormatter.format(maxCapacity));
        lore.add("¬ß7Niveau: ¬ßf" + playerData.getAutominerStorageLevel());
        lore.add("");

        if (storage.isEmpty()) {
            lore.add("¬ß8Stockage vide");
        } else {
            lore.add("¬ß7Contenu:");
            int count = 0;
            for (Map.Entry<Material, Long> entry : storage.entrySet()) {
                if (count >= 5) {
                    lore.add("¬ß8... et " + (storage.size() - 5) + " autres");
                    break;
                }
                String materialName = entry.getKey().name().toLowerCase().replace("_", " ");
                lore.add("¬ß8‚Ä¢ ¬ßf" + materialName + ": ¬ße" + NumberFormatter.format(entry.getValue()));
                count++;
            }
        }

        lore.add("");
        lore.add("¬ßeClic: ¬ß7Ouvrir le stockage");

        plugin.getGUIManager().applyLore(meta, lore);
        item.setItemMeta(meta);
        return item;
    }

    private ItemStack createFuelItem(PlayerData playerData) {
        ItemStack item = HeadUtils.createHead(HeadEnum.FUEL);
        ItemMeta meta = item.getItemMeta();

        plugin.getGUIManager().applyName(meta, "¬ßc‚õΩ Carburant");
        List<String> lore = new ArrayList<>();

        double fuelReserve = playerData.getAutominerFuelReserve();
        lore.add("¬ß7R√©serve: ¬ßf" + NumberFormatter.format((long) fuelReserve) + " t√™tes");

        // Calculer l'autonomie
        double totalConsumption = 0;
        ItemStack slot1 = playerData.getActiveAutominerSlot1();
        ItemStack slot2 = playerData.getActiveAutominerSlot2();

        if (slot1 != null) {
            totalConsumption += plugin.getAutominerManager().calculateFuelConsumption(slot1);
        }
        if (slot2 != null) {
            totalConsumption += plugin.getAutominerManager().calculateFuelConsumption(slot2);
        }

        if (totalConsumption > 0) {
            long autonomySeconds = (long) (fuelReserve / totalConsumption);
            lore.add("¬ß7Autonomie: ¬ßf" + formatTime(autonomySeconds));
        } else {
            lore.add("¬ß7Autonomie: ¬ß8Aucun automineur actif");
        }

        lore.add("");
        lore.add("¬ßeClic: ¬ß7Ajouter du carburant");

        plugin.getGUIManager().applyLore(meta, lore);
        item.setItemMeta(meta);
        return item;
    }

    private ItemStack createCondensationItem() {
        ItemStack item = HeadUtils.createHead(HeadEnum.CRAFTING);
        ItemMeta meta = item.getItemMeta();

        plugin.getGUIManager().applyName(meta, "¬ßdüîß Condensation");
        List<String> lore = new ArrayList<>();
        lore.add("¬ß7Fusionnez 9 automineurs identiques");
        lore.add("¬ß7pour obtenir 1 du type sup√©rieur");
        lore.add("");
        lore.add("¬ß8Pierre ‚Üí Fer ‚Üí Or ‚Üí Diamant ‚Üí √âmeraude ‚Üí Beacon");
        lore.add("");
        lore.add("¬ßeClic: ¬ß7Ouvrir la condensation");

        plugin.getGUIManager().applyLore(meta, lore);
        item.setItemMeta(meta);
        return item;
    }

    private void fillEmptySlots(Inventory inv) {
        ItemStack filler = new ItemStack(Material.BLACK_STAINED_GLASS_PANE);
        ItemMeta fillerMeta = filler.getItemMeta();
        plugin.getGUIManager().applyName(fillerMeta, " ");
        filler.setItemMeta(fillerMeta);

        for (int i = 0; i < inv.getSize(); i++) {
            if (inv.getItem(i) == null) {
                inv.setItem(i, filler);
            }
        }
    }

    private String generateRandomWorld(String currentWorld) {
        String[] worlds = {"mine-a", "mine-b", "mine-c", "mine-d", "mine-e", "mine-f", "mine-g", "mine-h",
                "mine-i", "mine-j", "mine-k", "mine-l", "mine-m", "mine-n", "mine-o", "mine-p",
                "mine-q", "mine-r", "mine-s", "mine-t", "mine-u", "mine-v", "mine-w", "mine-x",
                "mine-y", "mine-z"};

        String newWorld;
        do {
            newWorld = worlds[(int) (Math.random() * worlds.length)];
        } while (newWorld.equals(currentWorld));

        return newWorld;
    }

    private long calculateWorldChangeCost() {
        return 5; // 5 beacons par changement de monde
    }

    private String formatTime(long seconds) {
        if (seconds < 60) {
            return seconds + "s";
        } else if (seconds < 3600) {
            return (seconds / 60) + "min " + (seconds % 60) + "s";
        } else {
            long hours = seconds / 3600;
            long minutes = (seconds % 3600) / 60;
            return hours + "h " + minutes + "min";
        }
    }

    private String formatMaterialName(Material material) {
        return switch (material) {
            case COAL_ORE -> "Minerai de Charbon";
            case IRON_ORE -> "Minerai de Fer";
            case GOLD_ORE -> "Minerai d'Or";
            case DIAMOND_ORE -> "Minerai de Diamant";
            case EMERALD_ORE -> "Minerai d'√âmeraude";
            case REDSTONE_ORE -> "Minerai de Redstone";
            case LAPIS_ORE -> "Minerai de Lapis-Lazuli";
            case ANCIENT_DEBRIS -> "D√©bris Antiques";
            case NETHERITE_BLOCK -> "Bloc de Netherite";
            case BEACON -> "Beacon";
            case STONE -> "Pierre";
            case COBBLESTONE -> "Pierre Taill√©e";
            default -> {
                String name = material.name().toLowerCase().replace("_", " ");
                String[] words = name.split("");
                StringBuilder formatted = new StringBuilder();
                for (String word : words) {
                    if (!word.isEmpty()) {
                        formatted.append(Character.toUpperCase(word.charAt(0)))
                                .append(word.substring(1))
                                .append(" ");
                    }
                }
                yield formatted.toString().trim();
            }
        };
    }

    private long getDefaultPrice(Material material) {
        return switch (material) {
            case STONE, COBBLESTONE -> 1L;
            case COAL_ORE -> 5L;
            case IRON_ORE -> 10L;
            case GOLD_ORE -> 25L;
            case DIAMOND_ORE -> 100L;
            case EMERALD_ORE -> 150L;
            case REDSTONE_ORE -> 15L;
            case LAPIS_ORE -> 20L;
            case ANCIENT_DEBRIS -> 500L;
            case NETHERITE_BLOCK -> 1000L;
            case BEACON -> 2000L;
            default -> 1L;
        };
    }
}