package fr.prisontycoon.gui;

import fr.prisontycoon.PrisonTycoon;
import fr.prisontycoon.commands.PrestigeCommand;
import fr.prisontycoon.data.BankType;
import fr.prisontycoon.data.PlayerData;
import fr.prisontycoon.prestige.PrestigeReward;
import fr.prisontycoon.prestige.PrestigeTalent;
import fr.prisontycoon.utils.NumberFormatter;
import org.bukkit.Bukkit;
import org.bukkit.Material;
import org.bukkit.NamespacedKey;
import org.bukkit.Sound;
import org.bukkit.enchantments.Enchantment;
import org.bukkit.entity.Player;
import org.bukkit.event.inventory.ClickType;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.ItemFlag;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.ItemMeta;
import org.bukkit.persistence.PersistentDataType;

import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

import static java.util.stream.Collectors.joining;

/**
 * Interface graphique REFONTE pour le syst√®me de prestige
 * - Talents et r√©compenses dans le m√™me menu
 * - Organisation en lignes par niveau, colonnes par type
 * - Pages dynamiques selon le prestige
 * - Syst√®me de r√©initialisation des talents
 */
public class PrestigeGUI {

    // Slots du menu principal - NOUVEAU LAYOUT
    private static final int PRESTIGE_INFO_SLOT = 4;
    private static final int COMBINED_BUTTON_SLOT = 15; // Talents & R√©compenses
    private static final int RESET_TALENTS_SLOT = 14; // R√©initialiser talents
    private static final int PERFORM_PRESTIGE_SLOT = 11;
    private static final int HELP_SLOT = 9;
    private static final int CLOSE_SLOT = 26;

    // Layout du menu talents/r√©compenses (54 slots)
    // 5 prestiges par page, 3 slots par prestige (colonnes)
    private static final int[] PRESTIGE_ROWS = {3, 12, 21, 30, 39}; // 5 lignes

    // Navigation
    private static final int PREV_PAGE_SLOT = 45;
    private static final int NEXT_PAGE_SLOT = 53;
    private static final int BACK_SLOT = 49;
    private static final long RESET_CONFIRMATION_TIMEOUT = 30000; // 30 secondes
    private final PrisonTycoon plugin;
    private final NamespacedKey actionKey;
    private final NamespacedKey prestigeLevelKey;
    private final NamespacedKey rewardIdKey;
    private final NamespacedKey talentKey;
    private final Map<UUID, Integer> currentPages = new ConcurrentHashMap<>();


    public PrestigeGUI(PrisonTycoon plugin) {
        this.plugin = plugin;
        this.actionKey = new NamespacedKey(plugin, "prestige_action");
        this.prestigeLevelKey = new NamespacedKey(plugin, "prestige_level");
        this.rewardIdKey = new NamespacedKey(plugin, "reward_id");
        this.talentKey = new NamespacedKey(plugin, "talent_name");
    }

    /**
     * Ouvre le menu principal du prestige
     */
    public void openMainPrestigeMenu(Player player) {
        Inventory gui = plugin.getGUIManager().createInventory(27, "¬ß6üèÜ ¬ßlSyst√®me de Prestige ¬ß6üèÜ");
        plugin.getGUIManager().registerOpenGUI(player, GUIType.PRESTIGE_MENU, gui);

        plugin.getGUIManager().fillBorders(gui);
        setupMainPrestigeMenu(gui, player);

        player.openInventory(gui);
        player.playSound(player.getLocation(), Sound.BLOCK_BEACON_ACTIVATE, 0.7f, 1.2f);
    }

    /**
     * Configure le menu principal du prestige
     */
    private void setupMainPrestigeMenu(Inventory gui, Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        // Informations de prestige au centre-haut
        gui.setItem(PRESTIGE_INFO_SLOT, createPrestigeInfoItem(player));

        // NOUVEAU: R√©sum√© des talents actifs
        gui.setItem(13, createTalentSummaryButton(player)); // Centre

        // Bouton principal : Talents & R√©compenses combin√©s avec compteurs
        gui.setItem(COMBINED_BUTTON_SLOT, createCombinedButton(player));

        // Bouton r√©initialisation des talents
        gui.setItem(RESET_TALENTS_SLOT, createResetTalentsButton(player));

        // Bouton de prestige (si possible)
        if (plugin.getPrestigeManager().canPrestige(player)) {
            gui.setItem(PERFORM_PRESTIGE_SLOT, createPerformPrestigeButton(player, playerData.getPrestigeLevel() + 1));
        } else {
            gui.setItem(PERFORM_PRESTIGE_SLOT, createLockedPrestigeButton());
        }

        // Navigation
        gui.setItem(HELP_SLOT, createHelpItem());
        gui.setItem(CLOSE_SLOT, createCloseItem());
    }

    /**
     * Ouvre le menu combin√© talents/r√©compenses avec pages dynamiques
     */
    public void openCombinedMenu(Player player, int page) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        int maxPrestige = playerData.getPrestigeLevel();

        // 54 slots, 5 prestiges par page
        int maxPage = (maxPrestige - 1) / 5;
        page = Math.max(0, Math.min(page, maxPage));

        Inventory gui = plugin.getGUIManager().createInventory(54, "¬ß6üèÜ Progression Prestige : P" + (page * 5 + 1) + "-P" + Math.min((page + 1) * 5, maxPrestige));

        plugin.getGUIManager().fillBorders(gui);
        setupProgressionMenu(gui, player, page);

        player.openInventory(gui);
        player.playSound(player.getLocation(), Sound.BLOCK_BEACON_ACTIVATE, 0.7f, 1.2f);
    }

    private void setupProgressionMenu(Inventory gui, Player player, int page) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        int maxPrestige = playerData.getPrestigeLevel();

        // 5 lignes de prestige par page
        for (int i = 0; i < 5; i++) {
            int prestigeLevel = page * 5 + i + 1;
            if (prestigeLevel > 50) break; // Max P50

            int baseSlot = PRESTIGE_ROWS[i];
            setupPrestigeRow(gui, player, prestigeLevel, baseSlot);
        }

        // Navigation
        if (page > 0) {
            gui.setItem(PREV_PAGE_SLOT, createPageButton("¬ßc‚¨Ö Page pr√©c√©dente", page - 1));
        }

        int maxPage = (Math.min(maxPrestige, 50) - 1) / 5;
        if (page < maxPage) {
            gui.setItem(NEXT_PAGE_SLOT, createPageButton("¬ßaPage suivante ‚û°", page + 1));
        }

        gui.setItem(BACK_SLOT, createBackToMainButton());
    }

    private void setupSpecialRewardRow(Inventory gui, Player player, int prestigeLevel, int baseSlot, boolean isUnlocked) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        List<PrestigeReward> rewards = PrestigeReward.SpecialRewards.getSpecialRewardsForPrestige(prestigeLevel);

        if (rewards.isEmpty()) return;

        // V√©rifier si un choix a d√©j√† √©t√© fait pour ce niveau
        String chosenRewardId = playerData.getChosenSpecialReward(prestigeLevel);
        boolean hasChoice = chosenRewardId != null;

        if (rewards.size() == 1) {
            // R√©compense unique (P10, P20, etc.) - centrer sur la colonne du milieu
            PrestigeReward reward = rewards.getFirst();
            boolean isChosen = reward.id().equals(chosenRewardId);
            gui.setItem(baseSlot + 1, createExclusiveRewardItem(player, reward, prestigeLevel, isUnlocked, isChosen, hasChoice));
        } else {
            // Choix multiple (P5, P15, etc.) - √©taler sur les 3 colonnes
            for (int col = 0; col < Math.min(3, rewards.size()); col++) {
                PrestigeReward reward = rewards.get(col);
                boolean isChosen = reward.id().equals(chosenRewardId);

                // CORRECTION: Si hasChoice = true et cette r√©compense n'est pas choisie,
                // alors createExclusiveRewardItem va utiliser du Glass
                gui.setItem(baseSlot + col, createExclusiveRewardItem(player, reward, prestigeLevel, isUnlocked, isChosen, hasChoice));
            }
        }
    }

    /**
     * Cr√©e un item de r√©compense avec syst√®me exclusif
     */
    private ItemStack createExclusiveRewardItem(Player player, PrestigeReward reward, int prestigeLevel,
                                                boolean isUnlocked, boolean isChosen, boolean hasAnyChoice) {
        Material material;
        if (isChosen) {
            material = Material.CHEST; // R√©compense choisie
        } else if (hasAnyChoice) {
            material = Material.GRAY_STAINED_GLASS_PANE; // Autre choix fait
        } else if (isUnlocked) {
            material = Material.ENDER_CHEST; // Disponible
        } else {
            material = Material.BARRIER; // Verrouill√©
        }

        ItemStack item = new ItemStack(material);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            String prefix;
            String nameColor;
            List<String> statusLore = new ArrayList<>();

            if (isChosen) {
                // R√âCOMPENSE CHOISIE ET R√âCUP√âR√âE
                prefix = "¬ßa‚úÖ ";
                nameColor = "¬ßa¬ßl";
                statusLore.add("¬ßa‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                statusLore.add("¬ßaüéÅ R√âCOMPENSE R√âCUP√âR√âE");
                statusLore.add("¬ß7Cette r√©compense a √©t√© choisie et");
                statusLore.add("¬ß7appliqu√©e √† votre compte pour P" + prestigeLevel + ".");
                statusLore.add("¬ßa‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");

                meta.addEnchant(Enchantment.UNBREAKING, 1, true);
                meta.addItemFlags(ItemFlag.HIDE_ENCHANTS);

            } else if (hasAnyChoice) {
                // AUTRE R√âCOMPENSE D√âJ√Ä CHOISIE
                prefix = "¬ß8‚úó ";
                nameColor = "¬ß8";
                statusLore.add("¬ß8‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                statusLore.add("¬ßc‚ùå NON R√âCLAMABLE");
                statusLore.add("¬ß7Vous avez d√©j√† choisi une autre");
                statusLore.add("¬ß7r√©compense pour le niveau P" + prestigeLevel + ".");
                statusLore.add("¬ß7");
                statusLore.add("¬ß7üí° Une seule r√©compense par niveau!");
                statusLore.add("¬ß8‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");

            } else if (isUnlocked) {
                // R√âCOMPENSE DISPONIBLE
                prefix = "¬ßeüéÅ ";
                nameColor = "¬ße¬ßl";
                statusLore.add("¬ße‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                statusLore.add("¬ß6üåü R√âCOMPENSE DISPONIBLE");
                statusLore.add("¬ß7Vous pouvez choisir cette r√©compense");
                statusLore.add("¬ß7sp√©ciale pour P" + prestigeLevel + ".");
                statusLore.add("¬ß7");
                statusLore.add("¬ßc‚ö† Attention: ¬ß7Choix d√©finitif!");
                statusLore.add("¬ß7Les autres r√©compenses seront perdues.");
                statusLore.add("¬ße‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                statusLore.add("¬ßa‚û§ Cliquez pour choisir");

                meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "choose_reward");
                meta.getPersistentDataContainer().set(rewardIdKey, PersistentDataType.STRING, reward.id());
                meta.getPersistentDataContainer().set(prestigeLevelKey, PersistentDataType.INTEGER, prestigeLevel);

            } else {
                // R√âCOMPENSE VERROUILL√âE
                prefix = "¬ßcüîí ";
                nameColor = "¬ßc";
                statusLore.add("¬ßc‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                statusLore.add("¬ß4‚ùå R√âCOMPENSE VERROUILL√âE");
                statusLore.add("¬ß7Atteignez le niveau ¬ß6P" + prestigeLevel);
                statusLore.add("¬ß7pour d√©bloquer cette r√©compense.");
                statusLore.add("¬ßc‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
            }

            plugin.getGUIManager().applyName(meta, prefix + nameColor + reward.displayName() + " ¬ß7(P" + prestigeLevel + ")");

            // Construire la lore compl√®te
            List<String> lore = new ArrayList<>();
            lore.add("¬ßf" + reward.description());
            lore.add("");
            lore.addAll(statusLore);

            plugin.getGUIManager().applyLore(meta, lore);
            item.setItemMeta(meta);
        }

        return item;
    }

    /**
     * Cr√©e un item de r√©compense am√©lior√©
     */
    // ==================== DIFF√âRENCIATION VISUELLE DES TALENTS DANS LE MENU PROGRESSION ====================
    private void setupTalentRow(Inventory gui, Player player, int prestigeLevel, int baseSlot, boolean isUnlocked) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        // Obtenir tous les talents disponibles pour ce niveau
        PrestigeTalent[] availableTalents = PrestigeTalent.getTalentsForPrestige(prestigeLevel);
        if (availableTalents.length == 0) return;

        // V√©rifier si un choix a d√©j√† √©t√© fait pour ce niveau
        PrestigeTalent chosenTalent = playerData.getChosenPrestigeColumn(prestigeLevel);
        boolean hasChoice = chosenTalent != null;

        // Afficher chaque talent sur sa colonne
        for (int col = 0; col < Math.min(3, availableTalents.length); col++) {
            PrestigeTalent talent = availableTalents[col];
            boolean isChosen = talent.equals(chosenTalent);

            ItemStack item = createTalentColumnItem(player, talent, prestigeLevel, col,
                    isUnlocked, isChosen, hasChoice);
            gui.setItem(baseSlot + col, item);
        }
    }


    /**
     * Cr√©e un item pour une colonne de talent sp√©cifique
     */
    private ItemStack createTalentColumnItem(Player player, PrestigeTalent talent, int prestigeLevel,
                                             int column, boolean isUnlocked, boolean isChosen, boolean hasAnyChoice) {
        // D√©terminer le mat√©riau selon l'√©tat
        Material material;
        if (isChosen) {
            material = getTalentMaterialForBonus(talent, true); // Version brillante
        } else if (hasAnyChoice) {
            material = Material.GRAY_STAINED_GLASS_PANE; // Autre choix fait
        } else if (isUnlocked) {
            material = getTalentMaterialForBonus(talent, false); // Version normale
        } else {
            material = Material.BLACK_STAINED_GLASS_PANE; // Verrouill√©
        }

        ItemStack item = new ItemStack(material);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            String prefix;
            String nameColor;
            List<String> statusLore = new ArrayList<>();

            if (isChosen) {
                // BONUS CHOISI ET ACTIF
                prefix = "¬ßa‚úÖ ";
                nameColor = "¬ßa¬ßl";
                statusLore.add("¬ßa‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                statusLore.add("¬ßa‚ú® BONUS ACTIF ‚ú®");
                statusLore.add("¬ß7Ce bonus est appliqu√© √† votre compte");
                statusLore.add("¬ß7depuis le niveau P" + prestigeLevel + ".");
                statusLore.add("¬ßa‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");

                meta.addEnchant(Enchantment.UNBREAKING, 1, true);
                meta.addItemFlags(ItemFlag.HIDE_ENCHANTS);

            } else if (hasAnyChoice) {
                // AUTRE BONUS D√âJ√Ä CHOISI
                prefix = "¬ß8‚úó ";
                nameColor = "¬ß8";
                statusLore.add("¬ß8‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                statusLore.add("¬ßc‚ùå NON S√âLECTIONNABLE");
                statusLore.add("¬ß7Vous avez d√©j√† choisi un autre bonus");
                statusLore.add("¬ß7pour le niveau P" + prestigeLevel + ".");
                statusLore.add("¬ß7");
                statusLore.add("¬ß7üí° Utilisez ¬ße¬ßlR√©initialiser Talents");
                statusLore.add("¬ß7pour rechoisir (500 beacons)");
                statusLore.add("¬ß8‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");

            } else if (isUnlocked) {
                // BONUS DISPONIBLE
                prefix = "¬ße‚≠ò ";
                nameColor = "¬ße¬ßl";
                statusLore.add("¬ße‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                statusLore.add("¬ß6üåü DISPONIBLE");
                statusLore.add("¬ß7Vous pouvez s√©lectionner ce bonus");
                statusLore.add("¬ß7pour le niveau P" + prestigeLevel + ".");
                statusLore.add("¬ß7");
                statusLore.add("¬ßc‚ö† Attention: ¬ß7Choix d√©finitif!");
                statusLore.add("¬ß7Seul ce bonus sera actif, pas les autres.");
                statusLore.add("¬ße‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                statusLore.add("¬ßa‚û§ Cliquez pour s√©lectionner");

                // Ajouter les donn√©es pour le clic
                meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "choose_column");
                meta.getPersistentDataContainer().set(prestigeLevelKey, PersistentDataType.INTEGER, prestigeLevel);
                meta.getPersistentDataContainer().set(talentKey, PersistentDataType.STRING, talent.name());

            } else {
                // BONUS VERROUILL√â
                prefix = "¬ßcüîí ";
                nameColor = "¬ßc";
                statusLore.add("¬ßc‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                statusLore.add("¬ß4‚ùå VERROUILL√â");
                statusLore.add("¬ß7Atteignez le niveau ¬ß6P" + prestigeLevel);
                statusLore.add("¬ß7pour d√©bloquer ce bonus.");
                statusLore.add("¬ßc‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
            }

            // Nom du bonus
            plugin.getGUIManager().applyName(meta, prefix + nameColor + talent.getDisplayName() + " ¬ß7(P" + prestigeLevel + ")");

            // Construire la lore compl√®te
            List<String> lore = new ArrayList<>();
            lore.add("¬ßf" + talent.getDescription());
            lore.add("");
            lore.addAll(statusLore);

            plugin.getGUIManager().applyLore(meta, lore);
            item.setItemMeta(meta);
        }

        return item;
    }

    /**
     * D√©termine le mat√©riau selon le type de bonus
     */
    private Material getTalentMaterialForBonus(PrestigeTalent talent, boolean isActive) {
        Material baseMaterial = switch (talent) {
            case MONEY_GREED_BONUS -> Material.GOLD_NUGGET;
            case SELL_PRICE_BONUS -> Material.EMERALD;
            case OUTPOST_BONUS -> Material.BEACON;
            case TOKEN_GREED_BONUS -> Material.DIAMOND;
            case TAX_REDUCTION -> Material.REDSTONE;
            case PVP_MERCHANT_REDUCTION -> Material.IRON_SWORD;
        };

        // Version am√©lior√©e si le bonus est actif
        if (isActive) {
            return switch (baseMaterial) {
                case GOLD_NUGGET -> Material.GOLD_INGOT;
                case EMERALD -> Material.EMERALD_BLOCK;
                case DIAMOND -> Material.DIAMOND_BLOCK;
                case REDSTONE -> Material.REDSTONE_BLOCK;
                case IRON_SWORD -> Material.NETHERITE_SWORD;
                default -> baseMaterial;
            };
        }

        return baseMaterial;
    }

    // Modifier setupPrestigeRow pour inclure l'en-t√™te :
    private void setupPrestigeRow(Inventory gui, Player player, int prestigeLevel, int baseSlot) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        boolean isUnlocked = prestigeLevel <= playerData.getPrestigeLevel();

        if (prestigeLevel % 5 == 0) {
            // Palier sp√©cial : r√©compenses
            setupSpecialRewardRow(gui, player, prestigeLevel, baseSlot, isUnlocked);
        } else {
            // Palier normal : talents
            setupTalentRow(gui, player, prestigeLevel, baseSlot, isUnlocked);
        }
    }

    /**
     * Met √† jour la gestion des clics pour la navigation (CORRIG√â)
     */
    public void handleClick(Player player, ItemStack clickedItem, ClickType clickType) {
        if (clickedItem == null || !clickedItem.hasItemMeta()) return;

        ItemMeta meta = clickedItem.getItemMeta();
        String action = meta.getPersistentDataContainer().get(actionKey, PersistentDataType.STRING);

        if (action == null) return;

        switch (action) {
            case "choose_column" -> {
                Integer prestigeLevel = meta.getPersistentDataContainer().get(prestigeLevelKey, PersistentDataType.INTEGER);
                String talentName = meta.getPersistentDataContainer().get(talentKey, PersistentDataType.STRING);
                if (prestigeLevel != null && talentName != null) {
                    handleColumnChoice(player, prestigeLevel, talentName);
                }
            }
            case "choose_reward" -> {
                String rewardId = meta.getPersistentDataContainer().get(rewardIdKey, PersistentDataType.STRING);
                Integer prestigeLevel = meta.getPersistentDataContainer().get(prestigeLevelKey, PersistentDataType.INTEGER);
                if (rewardId != null && prestigeLevel != null) {
                    handleRewardChoice(player, rewardId, prestigeLevel);
                }
            }
            case "page_navigation" -> {
                // CORRECTION: Utiliser la bonne cl√© pour la page cible
                NamespacedKey targetPageKey = new NamespacedKey(plugin, "target_page");
                Integer targetPage = meta.getPersistentDataContainer().get(targetPageKey, PersistentDataType.INTEGER);
                if (targetPage != null) {
                    currentPages.put(player.getUniqueId(), targetPage);
                    openCombinedMenu(player, targetPage);
                }
            }
            case "open_combined" -> openCombinedMenu(player, 0);
            case "perform_prestige" -> {
                plugin.getPrestigeManager().performPrestige(player);
                player.closeInventory();
            }
            case "reset_talents" -> handleTalentReset(player);
            case "back_to_main" -> openMainPrestigeMenu(player);
        }
    }

    /**
     * G√®re le choix d'une colonne sp√©cifique (NOUVELLE M√âTHODE)
     */
    private void handleColumnChoice(Player player, int prestigeLevel, String talentName) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        // V√©rifier que le niveau est d√©bloqu√©
        if (prestigeLevel > playerData.getPrestigeLevel()) {
            player.sendMessage("¬ßc‚ùå Vous devez atteindre P" + prestigeLevel + " pour choisir ce bonus!");
            return;
        }

        // V√©rifier si un choix a d√©j√† √©t√© fait pour ce niveau
        PrestigeTalent existingChoice = playerData.getChosenPrestigeColumn(prestigeLevel);
        if (existingChoice != null) {
            player.sendMessage("¬ßc‚ùå Vous avez d√©j√† choisi un bonus pour P" + prestigeLevel + "!");
            player.sendMessage("¬ß7Choix actuel: ¬ße" + existingChoice.getDisplayName());
            player.sendMessage("¬ß7Utilisez la r√©initialisation des talents pour rechoisir.");
            return;
        }

        // V√©rifier que le talent est valide pour ce niveau
        try {
            PrestigeTalent talent = PrestigeTalent.valueOf(talentName);
            if (!talent.isAvailableForPrestige(prestigeLevel)) {
                player.sendMessage("¬ßc‚ùå Ce bonus n'est pas disponible pour P" + prestigeLevel + "!");
                return;
            }

            // Faire le choix
            playerData.choosePrestigeColumn(prestigeLevel, talent);

            // Messages et effets
            player.sendMessage("¬ßa‚úÖ Bonus s√©lectionn√© : " + talent.getDisplayName());
            player.sendMessage("¬ß7Effet: " + talent.getDescription());
            player.sendMessage("¬ß7Le bonus est maintenant actif!");
            player.playSound(player.getLocation(), Sound.ENTITY_EXPERIENCE_ORB_PICKUP, 1.0f, 1.5f);

            UUID playerId = player.getUniqueId();
            Integer currentPage = currentPages.getOrDefault(playerId, 0);

            // Sauvegarder
            plugin.getPlayerDataManager().markDirty(player.getUniqueId());

            // Rafra√Æchir l'interface
            player.closeInventory();
            openCombinedMenu(player, currentPage);

        } catch (IllegalArgumentException e) {
            player.sendMessage("¬ßc‚ùå Bonus invalide!");
        }
    }

    /**
     * G√®re le d√©verrouillage d'une r√©compense (gratuit)
     */
    private void handleRewardChoice(Player player, String rewardId, int prestigeLevel) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        // V√©rifier que le niveau est d√©bloqu√©
        if (prestigeLevel > playerData.getPrestigeLevel()) {
            player.sendMessage("¬ßc‚ùå Vous devez atteindre P" + prestigeLevel + " pour choisir cette r√©compense!");
            return;
        }

        // V√©rifier si un choix a d√©j√† √©t√© fait pour ce niveau
        if (playerData.hasRewardChoiceForLevel(prestigeLevel)) {
            String existingChoice = playerData.getChosenSpecialReward(prestigeLevel);
            player.sendMessage("¬ßc‚ùå Vous avez d√©j√† choisi une r√©compense pour P" + prestigeLevel + "!");

            // Trouver le nom de la r√©compense existante
            PrestigeReward existingReward = findRewardById(existingChoice);
            if (existingReward != null) {
                player.sendMessage("¬ß7Choix actuel: ¬ße" + existingReward.displayName());
            }
            return;
        }

        // R√©cup√©rer la r√©compense
        PrestigeReward reward = findRewardById(rewardId);
        if (reward == null) {
            player.sendMessage("¬ßc‚ùå R√©compense introuvable!");
            return;
        }

        // Faire le choix
        playerData.chooseSpecialReward(prestigeLevel, rewardId);

        // Donner la r√©compense
        plugin.getPrestigeManager().getRewardManager().giveSpecialReward(player, reward);

        // Messages et effets
        player.sendMessage("¬ßa‚úÖ R√©compense choisie : " + reward.displayName());
        player.sendMessage("¬ß7Cette r√©compense a √©t√© appliqu√©e √† votre compte!");
        player.sendMessage("¬ß7Les autres r√©compenses de P" + prestigeLevel + " ne sont plus disponibles.");
        player.playSound(player.getLocation(), Sound.ENTITY_PLAYER_LEVELUP, 1.0f, 1.2f);

        UUID playerId = player.getUniqueId();
        Integer currentPage = currentPages.getOrDefault(playerId, 0);

        // Sauvegarder
        plugin.getPlayerDataManager().markDirty(player.getUniqueId());

        // Rafra√Æchir l'interface
        player.closeInventory();
        openCombinedMenu(player, currentPage);
    }

    /**
     * Trouve une r√©compense par son ID
     */
    private PrestigeReward findRewardById(String rewardId) {
        // Extraire le niveau de prestige depuis l'ID (format: "p5_autominer", "p10_title", etc.)
        try {
            String levelStr = rewardId.substring(1, rewardId.indexOf("_"));
            int prestigeLevel = Integer.parseInt(levelStr);

            List<PrestigeReward> rewards = PrestigeReward.SpecialRewards.getSpecialRewardsForPrestige(prestigeLevel);

            for (PrestigeReward reward : rewards) {
                if (reward.id().equals(rewardId)) {
                    return reward;
                }
            }
        } catch (Exception e) {
            plugin.getPluginLogger().warning("Erreur lors de la recherche de r√©compense: " + rewardId);
        }

        return null;
    }


    /**
     * G√®re la r√©initialisation des talents
     */
    private void handleTalentReset(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        // V√©rification des beacons
        if (playerData.getBeacons() < 500) {
            player.sendMessage("¬ßc‚ùå Vous n'avez pas assez de beacons! Requis: ¬ße500");
            player.sendMessage("¬ß7Vous avez: ¬ßc" + playerData.getBeacons() + " beacons");
            return;
        }

        // V√©rification qu'il y a des talents √† r√©initialiser
        if (playerData.getPrestigeTalents().isEmpty()) {
            player.sendMessage("¬ßc‚ùå Vous n'avez aucun talent de prestige √† r√©initialiser!");
            return;
        }

        // NOUVEAU : Ajouter la confirmation en attente avec timestamp
        UUID playerId = player.getUniqueId();
        long currentTime = System.currentTimeMillis();

        // Obtenir l'instance de PrestigeCommand pour acc√©der √† la Map
        PrestigeCommand prestigeCommand = (PrestigeCommand) plugin.getCommand("prestige").getExecutor();
        prestigeCommand.addPendingResetConfirmation(playerId, currentTime);

        // Confirmation avec chrono
        player.sendMessage("¬ß6‚ö† CONFIRMATION REQUISE ‚ö†");
        player.sendMessage("¬ß7Cette action va:");
        player.sendMessage("¬ß7‚Ä¢ R√©initialiser TOUS vos talents de prestige");
        player.sendMessage("¬ß7‚Ä¢ Co√ªter ¬ßc500 beacons");
        player.sendMessage("¬ß7‚Ä¢ Les r√©compenses sp√©ciales ne seront PAS r√©cup√©rables");
        player.sendMessage("");
        player.sendMessage("¬ßaTapez ¬ße/prestige confirmer-reset ¬ßapour confirmer");
        player.sendMessage("¬ßc‚è∞ Vous avez 30 secondes pour confirmer");

        player.closeInventory();
        player.playSound(player.getLocation(), Sound.BLOCK_ANVIL_USE, 1.0f, 0.8f);

        // Programmer l'expiration automatique
        Bukkit.getScheduler().runTaskLater(plugin, () -> {
            if (prestigeCommand.removePendingResetConfirmation(playerId, currentTime)) {
                if (player.isOnline()) {
                    player.sendMessage("¬ßc‚è∞ D√©lai de confirmation √©coul√© pour la r√©initialisation des talents.");
                }
            }
        }, RESET_CONFIRMATION_TIMEOUT / 50); // Convertir ms en ticks
    }


    /**
     * Confirme la r√©initialisation des talents (appel√©e depuis la commande)
     */
    public void confirmTalentReset(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        // V√©rifier les beacons
        if (playerData.getBeacons() < 500) {
            player.sendMessage("¬ßc‚ùå Vous n'avez pas assez de beacons! (500 requis)");
            return;
        }

        // Effectuer la r√©initialisation
        playerData.removeBeacon(500);
        playerData.resetPrestigeTalents(); // Nouvelle m√©thode qui garde les r√©compenses

        // Messages et effets
        player.sendMessage("¬ßa‚úÖ Talents de prestige r√©initialis√©s!");
        player.sendMessage("¬ß7Co√ªt: ¬ßc-500 beacons");
        player.sendMessage("¬ß7Vos r√©compenses sp√©ciales sont conserv√©es");
        player.sendMessage("¬ß7Vous pouvez maintenant rechoisir vos talents");

        plugin.getPlayerDataManager().markDirty(player.getUniqueId());
        player.playSound(player.getLocation(), Sound.ENTITY_PLAYER_LEVELUP, 1.0f, 1.2f);

        // Fermer le menu et rouvrir le principal
        player.closeInventory();
        openMainPrestigeMenu(player);
    }


    // =============== M√âTHODES DE CR√âATION D'ITEMS ===============

    private ItemStack createPrestigeInfoItem(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        int prestigeLevel = playerData.getPrestigeLevel();

        Material material = prestigeLevel > 0 ? Material.NETHER_STAR : Material.GRAY_DYE;
        ItemStack item = new ItemStack(material);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            plugin.getGUIManager().applyName(meta, "¬ß6üèÜ Votre Prestige");

            List<String> lore = new ArrayList<>();
            lore.add("¬ß7Niveau actuel: " + playerData.getPrestigeDisplayName());
            lore.add("");

            if (prestigeLevel > 0) {
                lore.add("¬ße‚ö° Bonus actifs:");

                // Calculer les bonus totaux
                double moneyBonus = plugin.getGlobalBonusManager().getPrestigeMoneyGreedBonus(player);
                double tokenBonus = plugin.getGlobalBonusManager().getPrestigeTokenGreedBonus(player);
                double taxReduction = plugin.getGlobalBonusManager().getPrestigeTaxReduction(player);
                double sellBonus = plugin.getGlobalBonusManager().getPrestigeSellBonus(player);

                if (moneyBonus > 0) {
                    lore.add("¬ß7  ‚Ä¢ ¬ß6Money Greed: ¬ßa+" + String.format("%.1f", moneyBonus * 100) + "%");
                }
                if (tokenBonus > 0) {
                    lore.add("¬ß7  ‚Ä¢ ¬ßbToken Greed: ¬ßa+" + String.format("%.1f", tokenBonus * 100) + "%");
                }
                if (taxReduction > 0) {
                    lore.add("¬ß7  ‚Ä¢ ¬ßcR√©duction Taxe: ¬ßa-" + String.format("%.1f", taxReduction * 100) + "%");
                }
                if (sellBonus > 0) {
                    lore.add("¬ß7  ‚Ä¢ ¬ßePrix Vente: ¬ßa+" + String.format("%.1f", sellBonus * 100) + "%");
                }

                lore.add("");
                lore.add("¬ß7R√©compenses sp√©ciales r√©clam√©es: ¬ße" + playerData.getChosenSpecialRewards().size());
            } else {
                lore.add("¬ß7Atteignez le prestige 1 pour d√©bloquer des bonus!");
            }

            plugin.getGUIManager().applyLore(meta, lore);
            item.setItemMeta(meta);
        }

        return item;
    }

    /**
     * Cr√©e le bouton principal pour acc√©der aux talents & r√©compenses
     */
    private ItemStack createCombinedButton(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        int currentPrestige = playerData.getPrestigeLevel();

        // Calculer les statistiques avec le nouveau syst√®me
        int availableTalents = 0;
        int availableRewards = 0;
        int chosenTalents = 0;
        int chosenRewards = 0;
        int totalTalentLevels = Math.max(currentPrestige, 1);
        int totalRewardLevels = currentPrestige / 5; // Niveaux P5, P10, P15, etc.

        // Compter les talents disponibles et choisis (nouveau syst√®me)
        Map<Integer, PrestigeTalent> chosenColumns = playerData.getChosenPrestigeColumns();
        for (int level = 1; level <= currentPrestige; level++) {
            if (level % 5 != 0) { // Pas un niveau de r√©compense
                if (chosenColumns.containsKey(level)) {
                    chosenTalents++;
                } else {
                    // V√©rifier si des talents sont disponibles pour ce niveau
                    PrestigeTalent[] availableTalentsForLevel = PrestigeTalent.getTalentsForPrestige(level);
                    if (availableTalentsForLevel.length > 0) {
                        availableTalents++;
                    }
                }
            }
        }

        // Compter les r√©compenses disponibles et choisies (nouveau syst√®me)
        Map<Integer, String> chosenSpecialRewards = playerData.getChosenSpecialRewards();
        for (int level = 5; level <= currentPrestige; level += 5) {
            if (chosenSpecialRewards.containsKey(level)) {
                chosenRewards++;
            } else {
                // V√©rifier si des r√©compenses sont disponibles pour ce niveau
                List<PrestigeReward> rewardsForLevel = PrestigeReward.SpecialRewards.getSpecialRewardsForPrestige(level);
                if (!rewardsForLevel.isEmpty()) {
                    availableRewards++;
                }
            }
        }

        // D√©terminer le mat√©riau et l'√©tat du bouton
        Material material;
        boolean hasAvailable = availableTalents > 0 || availableRewards > 0;
        boolean hasChosen = chosenTalents > 0 || chosenRewards > 0;

        if (hasAvailable) {
            material = Material.ENCHANTED_BOOK; // Quelque chose d'disponible
        } else if (hasChosen) {
            material = Material.KNOWLEDGE_BOOK; // Seulement des √©l√©ments d√©j√† choisis
        } else {
            material = Material.BOOK; // Rien de disponible
        }

        ItemStack item = new ItemStack(material);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            // Titre dynamique selon l'√©tat
            String title;
            if (hasAvailable) {
                title = "¬ßeüìö ¬ßlTalents & R√©compenses ¬ße‚≠ê";
            } else if (hasChosen) {
                title = "¬ßaüìö ¬ßlTalents & R√©compenses ¬ßa‚úì";
            } else {
                title = "¬ß7üìö ¬ßlTalents & R√©compenses";
            }
            plugin.getGUIManager().applyName(meta, title);

            List<String> lore = new ArrayList<>();
            lore.add("¬ß7G√©rez vos talents et r√©compenses");
            lore.add("¬ß7de prestige dans un menu unifi√©.");
            lore.add("");

            // ============ SECTION TALENTS ============
            lore.add("¬ß6‚≠ê TALENTS DE PRESTIGE:");
            if (chosenTalents > 0) {
                lore.add("¬ßa‚Ä¢ Bonus s√©lectionn√©s: ¬ße" + chosenTalents + "¬ß7/" + (totalTalentLevels - totalRewardLevels));

                // Afficher les bonus totaux actifs
                Map<PrestigeTalent, Integer> activeTalents = playerData.getPrestigeTalents();
                double moneyGreed = calculateTotalColumnBonus(activeTalents, PrestigeTalent.MONEY_GREED_BONUS);
                double tokenGreed = calculateTotalColumnBonus(activeTalents, PrestigeTalent.TOKEN_GREED_BONUS);
                double sellBonus = calculateTotalColumnBonus(activeTalents, PrestigeTalent.SELL_PRICE_BONUS);
                double outpostBonus = calculateTotalColumnBonus(activeTalents, PrestigeTalent.OUTPOST_BONUS);
                double taxReduction = calculateTotalColumnBonus(activeTalents, PrestigeTalent.TAX_REDUCTION);
                double pvpReduction = calculateTotalColumnBonus(activeTalents, PrestigeTalent.PVP_MERCHANT_REDUCTION);

                List<String> activeBonus = new ArrayList<>();
                if (moneyGreed > 0) activeBonus.add("¬ß6Money +" + (int) moneyGreed + "%");
                if (tokenGreed > 0) activeBonus.add("¬ßbToken +" + (int) tokenGreed + "%");
                if (sellBonus > 0) activeBonus.add("¬ßaVente +" + (int) sellBonus + "%");
                if (outpostBonus > 0) activeBonus.add("¬ßeAvant-poste +" + (int) outpostBonus + "%");
                if (taxReduction > 0) activeBonus.add("¬ßcTaxe -" + (int) taxReduction + "%");
                if (pvpReduction > 0) activeBonus.add("¬ß9PvP -" + (int) pvpReduction + "%");

                if (!activeBonus.isEmpty()) {
                    String bonusLine = String.join("¬ß7, ", activeBonus);
                    // Couper la ligne si elle est trop longue
                    if (bonusLine.length() > 40) {
                        lore.add("¬ß7  Actifs: " + activeBonus.getFirst() + "¬ß7...");
                    } else {
                        lore.add("¬ß7  Actifs: " + bonusLine);
                    }
                }
            } else {
                lore.add("¬ßc‚Ä¢ Aucun bonus s√©lectionn√©");
            }

            if (availableTalents > 0) {
                lore.add("¬ße‚Ä¢ Disponibles: ¬ßa" + availableTalents + " choix¬ß7 en attente");
            }

            lore.add("");

            // ============ SECTION R√âCOMPENSES ============
            lore.add("¬ßdüéÅ R√âCOMPENSES SP√âCIALES:");
            if (chosenRewards > 0) {
                lore.add("¬ßa‚Ä¢ R√©compenses r√©clam√©es: ¬ße" + chosenRewards + "¬ß7/" + totalRewardLevels);

                // Afficher quelques r√©compenses r√©clam√©es
                List<String> rewardNames = new ArrayList<>();
                for (Map.Entry<Integer, String> entry : chosenSpecialRewards.entrySet()) {
                    if (rewardNames.size() >= 2) break; // Limite √† 2 pour l'espace

                    PrestigeReward reward = findRewardById(entry.getValue());
                    String name = reward != null ? reward.displayName() : "R√©compense P" + entry.getKey();
                    rewardNames.add("¬ßeP" + entry.getKey() + ": ¬ß7" + name);
                }

                if (!rewardNames.isEmpty()) {
                    for (String rewardName : rewardNames) {
                        lore.add("¬ß7  " + rewardName);
                    }
                    if (chosenRewards > rewardNames.size()) {
                        lore.add("¬ß7  ... et " + (chosenRewards - rewardNames.size()) + " autre(s)");
                    }
                }
            } else {
                lore.add("¬ßc‚Ä¢ Aucune r√©compense r√©clam√©e");
            }

            if (availableRewards > 0) {
                lore.add("¬ße‚Ä¢ Disponibles: ¬ßa" + availableRewards + " r√©compense" + (availableRewards > 1 ? "s" : ""));
            }

            lore.add("");

            // ============ SECTION ACTION ============
            if (hasAvailable) {
                lore.add("¬ßa‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                lore.add("¬ß6‚ú® ACTIONS DISPONIBLES ‚ú®");
                if (availableTalents > 0) {
                    lore.add("¬ß7‚Ä¢ S√©lectionner " + availableTalents + " talent" + (availableTalents > 1 ? "s" : ""));
                }
                if (availableRewards > 0) {
                    lore.add("¬ß7‚Ä¢ R√©clamer " + availableRewards + " r√©compense" + (availableRewards > 1 ? "s" : ""));
                }
                lore.add("¬ßa‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                lore.add("¬ße‚û§ Cliquez pour ouvrir le menu");

                // Ajouter un effet brillant
                meta.addEnchant(Enchantment.UNBREAKING, 1, true);
                meta.addItemFlags(ItemFlag.HIDE_ENCHANTS);
            } else if (hasChosen) {
                lore.add("¬ßa‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                lore.add("¬ßa‚úÖ PROGRESSION COMPL√àTE");
                lore.add("¬ß7Tous les talents et r√©compenses");
                lore.add("¬ß7disponibles ont √©t√© s√©lectionn√©s.");
                lore.add("¬ßa‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                lore.add("¬ße‚û§ Cliquez pour voir votre progression");
            } else {
                lore.add("¬ß8‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                lore.add("¬ß7Progressez en prestige pour d√©bloquer");
                lore.add("¬ß7des talents et r√©compenses sp√©ciales!");
                lore.add("¬ß8‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨");
                lore.add("¬ße‚û§ Cliquez pour voir les prestiges");
            }

            plugin.getGUIManager().applyLore(meta, lore);

            // Action pour ouvrir le menu combin√©
            meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "open_combined");

            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createResetTalentsButton(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        boolean hasEnoughBeacons = playerData.getBeacons() >= 500;
        boolean hasTalents = !playerData.getPrestigeTalents().isEmpty();

        Material material = hasEnoughBeacons && hasTalents ? Material.TNT : Material.BARRIER;
        ItemStack item = new ItemStack(material);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            plugin.getGUIManager().applyName(meta, "¬ßcüîÑ R√©initialiser Talents");

            List<String> lore = new ArrayList<>();
            lore.add("¬ß7Remet √† z√©ro tous vos talents");
            lore.add("¬ß7de prestige pour les r√©attribuer");
            lore.add("");
            lore.add("¬ß7Co√ªt: ¬ße500 beacons");
            lore.add("¬ß7Vos beacons: " + (hasEnoughBeacons ? "¬ßa" : "¬ßc") + playerData.getBeacons());
            lore.add("");

            if (!hasTalents) {
                lore.add("¬ßcAucun talent √† r√©initialiser");
            } else if (!hasEnoughBeacons) {
                lore.add("¬ßcBeacons insuffisants!");
            } else {
                lore.add("¬ß7‚ö† Les r√©compenses sp√©ciales");
                lore.add("¬ß7ne peuvent PAS √™tre r√©clam√©es √† nouveau");
                lore.add("");
                lore.add("¬ßeCliquez pour r√©initialiser");
            }

            plugin.getGUIManager().applyLore(meta, lore);

            if (hasEnoughBeacons && hasTalents) {
                meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "reset_talents");
            }

            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createPerformPrestigeButton(Player player, int nextLevel) {
        ItemStack item = new ItemStack(Material.NETHER_STAR);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            plugin.getGUIManager().applyName(meta, "¬ß6üöÄ Effectuer Prestige " + nextLevel);
            List<String> lore = new ArrayList<>();
            lore.add("¬ß7Passez au niveau de prestige suivant");
            lore.add("¬ß7et d√©bloquez de nouveaux bonus!");
            lore.add("");

            // Afficher le co√ªt de prestige
            long cost = plugin.getPrestigeManager().getPrestigeCost(player, nextLevel);
            lore.add("¬ß7Co√ªt: ¬ßc" + NumberFormatter.format(cost) + " coins");

            // Afficher l'effet de la banque
            PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
            BankType bankType = playerData.getBankType();
            if (bankType != BankType.NONE && bankType.getPrestigeCostMultiplier() != 1.0) {
                double multiplier = bankType.getPrestigeCostMultiplier();
                double percentage = (multiplier - 1.0) * 100.0;
                String effect = percentage > 0 ? "¬ßc+" + String.format("%.0f%%", percentage) : "¬ßa" + String.format("%.0f%%", percentage);
                lore.add("¬ß7Effet banque: " + effect + " ¬ß7sur le co√ªt");
            }

            lore.add("");
            lore.add("¬ßaConditions remplies!");
            lore.add("");
            lore.add("¬ßeCliquez pour prestigier!");

            plugin.getGUIManager().applyLore(meta, lore);
            meta.addEnchant(Enchantment.UNBREAKING, 1, true);
            meta.addItemFlags(ItemFlag.HIDE_ENCHANTS);
            meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "perform_prestige");
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createLockedPrestigeButton() {
        ItemStack item = new ItemStack(Material.BARRIER);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            plugin.getGUIManager().applyName(meta, "¬ßcüîí Prestige Verrouill√©");
            plugin.getGUIManager().applyLore(meta, List.of(
                    "¬ß7Vous devez remplir les conditions",
                    "¬ß7pour effectuer un prestige",
                    "",
                    "¬ß7Consultez ¬ße/prestige info ¬ß7pour",
                    "¬ß7voir les pr√©requis"
            ));
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createPageButton(String displayName, int targetPage) {
        ItemStack item = new ItemStack(targetPage > currentPages.getOrDefault(UUID.randomUUID(), 0) ?
                Material.ARROW : Material.SPECTRAL_ARROW);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            plugin.getGUIManager().applyName(meta, displayName);

            List<String> lore = new ArrayList<>();
            lore.add("¬ß7Aller √† la page " + (targetPage + 1));
            lore.add("¬ße‚û§ Cliquez pour naviguer");
            plugin.getGUIManager().applyLore(meta, lore);

            // CORRECTION: Utiliser la bonne action et cl√©
            meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "page_navigation");
            meta.getPersistentDataContainer().set(new NamespacedKey(plugin, "target_page"), PersistentDataType.INTEGER, targetPage);

            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createBackToMainButton() {
        ItemStack item = new ItemStack(Material.BARRIER);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            plugin.getGUIManager().applyName(meta, "¬ßc‚Üê Retour au menu principal");
            meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "back_to_main");
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createHelpItem() {
        ItemStack item = new ItemStack(Material.BOOK);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            plugin.getGUIManager().applyName(meta, "¬ße‚ùì Aide");
            plugin.getGUIManager().applyLore(meta, List.of(
                    "¬ß7Le syst√®me de prestige vous permet",
                    "¬ß7de recommencer avec des bonus permanents",
                    "",
                    "¬ß7‚Ä¢ Talents cycliques automatiques",
                    "¬ß7‚Ä¢ R√©compenses sp√©ciales tous les 5 niveaux",
                    "¬ß7‚Ä¢ Possibilit√© de r√©initialiser les talents",
                    "",
                    "¬ß7Plus d'infos: ¬ße/prestige help"
            ));
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createCloseItem() {
        ItemStack item = new ItemStack(Material.BARRIER);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            plugin.getGUIManager().applyName(meta, "¬ßc‚úó Fermer");
            item.setItemMeta(meta);
        }

        return item;
    }

    public void onPlayerQuit(Player player) {
        UUID playerId = player.getUniqueId();
        currentPages.remove(playerId);
    }

    private ItemStack createTalentSummaryButton(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        ItemStack item = new ItemStack(Material.ENCHANTED_BOOK);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            plugin.getGUIManager().applyName(meta, "¬ß6üìã ¬ßlR√©sum√© de Progression ¬ß6üìã");

            List<String> lore = new ArrayList<>();
            lore.add("¬ß7Votre progression compl√®te en prestige:");
            lore.add("");

            // ============ SECTION BONUS ACTIFS ============
            Map<Integer, PrestigeTalent> chosenColumns = playerData.getChosenPrestigeColumns();
            Map<PrestigeTalent, Integer> activeTalents = playerData.getPrestigeTalents();

            lore.add("¬ß6üåü BONUS ACTIFS:");
            if (chosenColumns.isEmpty()) {
                lore.add("¬ßc‚ùå Aucun bonus s√©lectionn√©");
                lore.add("¬ß7Progressez en prestige pour d√©bloquer");
                lore.add("¬ß7des bonus et am√©liorer vos performances!");
            } else {
                // Grouper par type de bonus avec comptage
                Map<PrestigeTalent, List<Integer>> bonusLevels = new HashMap<>();

                for (Map.Entry<Integer, PrestigeTalent> entry : chosenColumns.entrySet()) {
                    PrestigeTalent talent = entry.getValue();
                    bonusLevels.computeIfAbsent(talent, k -> new ArrayList<>()).add(entry.getKey());
                }

                // Afficher chaque type de bonus
                for (Map.Entry<PrestigeTalent, List<Integer>> entry : bonusLevels.entrySet()) {
                    PrestigeTalent talent = entry.getKey();
                    List<Integer> levels = entry.getValue();
                    int totalLevel = levels.size(); // Nouveau calcul : nombre de fois choisi

                    lore.add("¬ßa‚Ä¢ " + talent.getDisplayName() + " ¬ß7(√ó" + totalLevel + ")");
                    lore.add("¬ß7  Niveaux: ¬ß6" + levels.stream()
                            .sorted()
                            .map(l -> "P" + l)
                            .collect(joining(", ")));
                }

                lore.add("");
                // Calculs des bonus totaux
                double moneyGreed = calculateTotalColumnBonus(activeTalents, PrestigeTalent.MONEY_GREED_BONUS);
                double tokenGreed = calculateTotalColumnBonus(activeTalents, PrestigeTalent.TOKEN_GREED_BONUS);
                double sellBonus = calculateTotalColumnBonus(activeTalents, PrestigeTalent.SELL_PRICE_BONUS);
                double outpostBonus = calculateTotalColumnBonus(activeTalents, PrestigeTalent.OUTPOST_BONUS);
                double taxReduction = calculateTotalColumnBonus(activeTalents, PrestigeTalent.TAX_REDUCTION);
                double pvpReduction = calculateTotalColumnBonus(activeTalents, PrestigeTalent.PVP_MERCHANT_REDUCTION);

                lore.add("¬ß6üìä BONUS TOTAUX:");
                if (moneyGreed > 0) lore.add("¬ß6‚Ä¢ Money Greed: +" + (int) moneyGreed + "%");
                if (tokenGreed > 0) lore.add("¬ßb‚Ä¢ Token Greed: +" + (int) tokenGreed + "%");
                if (sellBonus > 0) lore.add("¬ßa‚Ä¢ Prix de vente: +" + (int) sellBonus + "%");
                if (outpostBonus > 0) lore.add("¬ße‚Ä¢ Gain avant-poste: +" + (int) outpostBonus + "%");
                if (taxReduction > 0) lore.add("¬ßc‚Ä¢ R√©duction taxe: -" + (int) taxReduction + "%");
                if (pvpReduction > 0) lore.add("¬ß9‚Ä¢ Prix marchand PvP: -" + (int) pvpReduction + "%");
            }

            lore.add("");

            // ============ SECTION R√âCOMPENSES SP√âCIALES ============
            Map<Integer, String> chosenRewards = playerData.getChosenSpecialRewards();
            lore.add("¬ßdüéÅ R√âCOMPENSES SP√âCIALES:");
            if (chosenRewards.isEmpty()) {
                lore.add("¬ßc‚ùå Aucune r√©compense r√©clam√©e");
                lore.add("¬ß7Atteignez P5, P10, P15... pour d√©bloquer");
                lore.add("¬ß7des r√©compenses sp√©ciales!");
            } else {
                for (Map.Entry<Integer, String> entry : chosenRewards.entrySet().stream()
                        .sorted(Map.Entry.comparingByKey())
                        .toList()) {
                    int level = entry.getKey();
                    String rewardId = entry.getValue();

                    PrestigeReward reward = findRewardById(rewardId);
                    String rewardName = reward != null ? reward.displayName() : rewardId;

                    lore.add("¬ßa‚Ä¢ P" + level + ": ¬ße" + rewardName);
                }
            }

            lore.add("");
            lore.add("¬ße‚û§ Cliquez pour voir la progression d√©taill√©e");

            plugin.getGUIManager().applyLore(meta, lore);
            meta.addEnchant(Enchantment.UNBREAKING, 1, true);
            meta.addItemFlags(ItemFlag.HIDE_ENCHANTS);

            meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "open_combined");

            item.setItemMeta(meta);
        }

        return item;
    }

    /**
     * Calcule le bonus total pour un type de talent sp√©cifique
     */
    private double calculateTotalColumnBonus(Map<PrestigeTalent, Integer> talents, PrestigeTalent targetTalent) {
        int level = talents.getOrDefault(targetTalent, 0);

        return switch (targetTalent) {
            case MONEY_GREED_BONUS, TOKEN_GREED_BONUS, SELL_PRICE_BONUS, OUTPOST_BONUS -> level * 3.0; // +3% par niveau
            case TAX_REDUCTION, PVP_MERCHANT_REDUCTION -> level * 1.0; // -1% par niveau
        };
    }
}