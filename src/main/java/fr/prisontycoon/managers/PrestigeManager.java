package fr.prisontycoon.managers;

import fr.prisontycoon.PrisonTycoon;
import fr.prisontycoon.data.PlayerData;
import org.bukkit.Bukkit;
import org.bukkit.Sound;
import org.bukkit.entity.Player;

import java.util.ArrayList;
import java.util.List;

/**
 * Gestionnaire principal du syst√®me de prestige (CORRIG√â: sans rang FREE)
 */
public class PrestigeManager {

    private final PrisonTycoon plugin;
    private final PrestigeRewardManager rewardManager;

    public PrestigeManager(PrisonTycoon plugin) {
        this.plugin = plugin;
        this.rewardManager = new PrestigeRewardManager(plugin);
    }

    /**
     * CORRIG√â: V√©rifie si un joueur peut effectuer un prestige (rang Z requis au lieu de FREE)
     */
    public boolean canPrestige(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        // V√©rifier le rang Z (maximum) au lieu du rang FREE
        if (!playerData.hasCustomPermission("specialmine.mine.z")) {
            return false;
        }

        // V√©rifier le niveau de prestige maximum
        return playerData.getPrestigeLevel() < 50;

        // TODO: V√©rifier pas d'√©pargne active en banque
        // TODO: V√©rifier pas d'investissement actif
        // TODO: V√©rifier ne pas √™tre en challenge
    }

    /**
     * CORRIG√â: Effectue le prestige d'un joueur (reset vers rang A avec permission prestige)
     */
    public boolean performPrestige(Player player) {
        if (!canPrestige(player)) {
            return false;
        }

        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        int newPrestigeLevel = playerData.getPrestigeLevel() + 1;

        // Confirmation du prestige
        if (!confirmPrestige(player, newPrestigeLevel)) {
            return false;
        }

        // Sauvegarder l'ancien rang pour les messages
        String oldRank = getCurrentRank(player);

        // Effectuer le reset
        resetPlayerForPrestige(player);

        // Mettre √† jour le niveau de prestige via PlayerData (qui g√®re les permissions)
        playerData.setPrestigeLevel(newPrestigeLevel);

        // Appliquer imm√©diatement la permission si le joueur est en ligne
        Player onlinePlayer = plugin.getServer().getPlayer(player.getUniqueId());
        if (onlinePlayer != null && onlinePlayer.isOnline()) {
            String prestigePermission = "specialmine.prestige." + newPrestigeLevel;
            plugin.getPermissionManager().attachPermission(onlinePlayer, prestigePermission);
        }

        // Donner les r√©compenses automatiques
        rewardManager.giveAutomaticRewards(player, newPrestigeLevel);

        // G√©rer les talents ou r√©compenses sp√©ciales
        handlePrestigeRewardOrTalent(player, newPrestigeLevel);

        // Messages et effets
        sendPrestigeMessages(player, newPrestigeLevel);
        broadcastPrestige(player, newPrestigeLevel);

        // Effets sonores et visuels
        player.playSound(player.getLocation(), Sound.UI_TOAST_CHALLENGE_COMPLETE, 1.0f, 1.0f);

        plugin.getPluginLogger().info("Prestige effectu√©: " + player.getName() + " -> P" + newPrestigeLevel);

        return true;
    }

    /**
     * CORRIG√â: Obtient le rang actuel du joueur via PermissionManager
     */
    private String getCurrentRank(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        String highestRank = "a"; // Rang par d√©faut

        // Recherche du rang le plus √©lev√© via les permissions bukkit
        for (char c = 'z'; c >= 'a'; c--) {
            String minePermission = "specialmine.mine." + c;
            if (playerData.hasCustomPermission(minePermission)) {
                highestRank = String.valueOf(c);
                break;
            }
        }

        return highestRank;
    }

    /**
     * Demande confirmation au joueur pour le prestige
     */
    private boolean confirmPrestige(Player player, int newLevel) {
        // TODO: Impl√©menter une interface de confirmation
        // Pour l'instant, on assume que la confirmation a √©t√© faite via l'interface
        return true;
    }

    /**
     * CORRIG√â: Reset le joueur pour le prestige (retour au rang A via PermissionManager)
     */
    private void resetPlayerForPrestige(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        // Retirer toutes les permissions de mine via PermissionManager
        clearAllMinePermissions(player);

        // Remettre uniquement la permission de base (rang A) via PermissionManager
        plugin.getPermissionManager().attachPermission(player, "specialmine.mine.a");

        // Reset des coins
        playerData.setCoins(0);

        plugin.getPluginLogger().info("Reset de prestige effectu√© pour: " + player.getName() + " (retour au rang A)");
    }

    /**
     * CORRIG√â: Retire toutes les permissions de mine d'un joueur via PermissionManager (plus de FREE)
     */
    private void clearAllMinePermissions(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        for (char c = 'a'; c <= 'z'; c++) {
            String minePermission = "specialmine.mine." + c;
            if (playerData.hasCustomPermission(minePermission)) {
                plugin.getPermissionManager().detachPermission(player, minePermission);
            }
        }
    }

    /**
     * G√®re les talents ou r√©compenses sp√©ciales selon le niveau de prestige
     */
    private void handlePrestigeRewardOrTalent(Player player, int prestigeLevel) {
        if (prestigeLevel % 5 == 0) {
            // Paliers sp√©ciaux (P5, P10, P15, etc.)
            player.sendMessage("¬ß6üéÅ Palier sp√©cial P" + prestigeLevel + " atteint!");
            player.sendMessage("¬ß7Consultez /prestige talents pour d√©couvrir vos nouveaux bonus!");
        }

        // R√©compenses automatiques selon le niveau
        switch (prestigeLevel) {
            case 1 -> player.sendMessage("¬ßaüéâ Premier prestige! Bonus de vitesse permanente d√©bloqu√©!");
            case 5 -> player.sendMessage("¬ßbüéÅ P5 atteint! Bonus d'efficacit√© de minage d√©bloqu√©!");
            case 10 -> player.sendMessage("¬ßdüèÜ P10 atteint! Acc√®s aux mines de prestige d√©bloqu√©!");
            case 25 -> player.sendMessage("¬ß6üëë P25 atteint! Bonus de multiplicateur de coins d√©bloqu√©!");
            case 50 -> player.sendMessage("¬ßcüåü P50 atteint! Rang L√âGENDE d√©bloqu√©! F√©licitations!");
        }
    }

    /**
     * Envoie les messages de prestige au joueur
     */
    private void sendPrestigeMessages(Player player, int prestigeLevel) {
        player.sendMessage("¬ß6‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        player.sendMessage("¬ß6üèÜ        PRESTIGE R√âUSSI!        üèÜ");
        player.sendMessage("¬ß6‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        player.sendMessage("¬ß7Nouveau niveau de prestige: ¬ß6¬ßlP" + prestigeLevel);
        player.sendMessage("¬ß7Vous avez √©t√© reset au rang ¬ßeA ¬ß7avec des bonus permanents!");
        player.sendMessage("¬ß7Tapez ¬ße/prestige info ¬ß7pour voir vos avantages!");
        player.sendMessage("¬ß6‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    }

    /**
     * Annonce le prestige √† tous les joueurs
     */
    private void broadcastPrestige(Player player, int prestigeLevel) {
        String message = "¬ß6üèÜ " + player.getName() + " a atteint le Prestige " + prestigeLevel + "! üèÜ";

        for (Player onlinePlayer : Bukkit.getOnlinePlayers()) {
            onlinePlayer.sendMessage(message);
            onlinePlayer.playSound(onlinePlayer.getLocation(), Sound.UI_TOAST_CHALLENGE_COMPLETE, 0.5f, 1.0f);
        }
    }

    /**
     * V√©rifie si un joueur a un niveau de prestige sp√©cifique
     */
    public boolean hasPrestigeLevel(Player player, int level) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        return playerData.getPrestigeLevel() >= level;
    }

    /**
     * Obtient le niveau de prestige d'un joueur
     */
    public int getPrestigeLevel(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        return playerData.getPrestigeLevel();
    }

    /**
     * Obtient le gestionnaire de r√©compenses de prestige
     */
    public PrestigeRewardManager getRewardManager() {
        return rewardManager;
    }

    /**
     * NOUVEAU: V√©rifie si un joueur peut acc√©der √† une mine de prestige
     */
    public boolean canAccessPrestigeMine(Player player, int requiredPrestigeLevel) {
        return hasPrestigeLevel(player, requiredPrestigeLevel) && getCurrentRank(player).equals("z");
    }

    /**
     * NOUVEAU: Obtient la liste des mines de prestige accessibles
     */
    public List<String> getAccessiblePrestigeMines(Player player) {
        List<String> accessibleMines = new ArrayList<>();
        int playerPrestigeLevel = getPrestigeLevel(player);
        String currentRank = getCurrentRank(player);

        // V√©rifie que le joueur est au rang Z
        if (!currentRank.equals("z")) {
            return accessibleMines; // Liste vide si pas rang Z
        }

        // Ajoute les mines de prestige selon le niveau
        if (playerPrestigeLevel >= 1) {
            accessibleMines.add("mine-prestige1");
        }
        if (playerPrestigeLevel >= 11) {
            accessibleMines.add("mine-prestige11");
        }
        if (playerPrestigeLevel >= 21) {
            accessibleMines.add("mine-prestige21");
        }
        if (playerPrestigeLevel >= 31) {
            accessibleMines.add("mine-prestige31");
        }
        if (playerPrestigeLevel >= 41) {
            accessibleMines.add("mine-prestige41");
        }

        return accessibleMines;
    }

    /**
     * NOUVEAU: Affiche les informations de prestige du joueur
     */
    public String showPrestigeInfo(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        int prestigeLevel = playerData.getPrestigeLevel();
        String currentRank = getCurrentRank(player);

        player.sendMessage("¬ß6‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRESTIGE INFO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        player.sendMessage("¬ß7Niveau de prestige: ¬ß6P" + prestigeLevel);
        player.sendMessage("¬ß7Rang actuel: ¬ße" + currentRank.toUpperCase());

        if (canPrestige(player)) {
            player.sendMessage("¬ßa‚úÖ Vous pouvez effectuer un prestige!");
            player.sendMessage("¬ß7Tapez ¬ße/prestige effectuer ¬ß7pour continuer.");
        } else if (!currentRank.equals("z")) {
            player.sendMessage("¬ßc‚ùå Vous devez atteindre le rang Z pour prestigier.");
        } else if (prestigeLevel >= 50) {
            player.sendMessage("¬ß6üëë Prestige maximum atteint! Rang L√âGENDE!");
        }

        // Affiche les mines de prestige accessibles
        List<String> accessibleMines = getAccessiblePrestigeMines(player);
        if (!accessibleMines.isEmpty()) {
            player.sendMessage("¬ßdMines de prestige accessibles:");
            for (String mine : accessibleMines) {
                player.sendMessage("¬ß7- ¬ßd" + mine);
            }
        }

        player.sendMessage("¬ß6‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        return currentRank;
    }
}