package fr.prisontycoon.GUI;

import fr.prisontycoon.PrisonTycoon;
import fr.prisontycoon.data.PlayerData;
import fr.prisontycoon.prestige.*;
import org.bukkit.Bukkit;
import org.bukkit.Material;
import org.bukkit.NamespacedKey;
import org.bukkit.Sound;
import org.bukkit.enchantments.Enchantment;
import org.bukkit.entity.Player;
import org.bukkit.event.inventory.ClickType;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.ItemMeta;
import org.bukkit.persistence.PersistentDataType;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

/**
 * Interface graphique pour le syst√®me de prestige
 */
public class PrestigeGUI {

    private final PrisonTycoon plugin;
    private final NamespacedKey actionKey;
    private final NamespacedKey prestigeLevelKey;
    private final NamespacedKey rewardIdKey;
    private final NamespacedKey talentKey;

    // Slots du menu principal
    private static final int PRESTIGE_INFO_SLOT = 13;
    private static final int REWARDS_BUTTON_SLOT = 11;
    private static final int TALENTS_BUTTON_SLOT = 15;
    private static final int PERFORM_PRESTIGE_SLOT = 31;
    private static final int MINES_INFO_SLOT = 22;
    private static final int HELP_SLOT = 18;
    private static final int CLOSE_SLOT = 26;

    public PrestigeGUI(PrisonTycoon plugin) {
        this.plugin = plugin;
        this.actionKey = new NamespacedKey(plugin, "prestige_action");
        this.prestigeLevelKey = new NamespacedKey(plugin, "prestige_level");
        this.rewardIdKey = new NamespacedKey(plugin, "reward_id");
        this.talentKey = new NamespacedKey(plugin, "talent_name");
    }

    /**
     * Ouvre le menu principal du prestige
     */
    public void openMainPrestigeMenu(Player player) {
        Inventory gui = Bukkit.createInventory(null, 45, "¬ß6üèÜ ¬ßlSyst√®me de Prestige ¬ß6üèÜ");

        fillWithGlass(gui);
        setupMainPrestigeMenu(gui, player);

        player.openInventory(gui);
        player.playSound(player.getLocation(), Sound.BLOCK_BEACON_ACTIVATE, 0.7f, 1.2f);
    }

    /**
     * Configure le menu principal du prestige
     */
    private void setupMainPrestigeMenu(Inventory gui, Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        // Informations de prestige au centre
        gui.setItem(PRESTIGE_INFO_SLOT, createPrestigeInfoItem(player));

        // Boutons principaux
        gui.setItem(REWARDS_BUTTON_SLOT, createRewardsButton());
        gui.setItem(TALENTS_BUTTON_SLOT, createTalentsButton());
        gui.setItem(MINES_INFO_SLOT, createMinesInfoItem(player));

        // Bouton de prestige (si possible)
        if (plugin.getPrestigeManager().canPrestige(player)) {
            gui.setItem(PERFORM_PRESTIGE_SLOT, createPerformPrestigeButton(playerData.getPrestigeLevel() + 1));
        } else {
            gui.setItem(PERFORM_PRESTIGE_SLOT, createLockedPrestigeButton());
        }

        // Navigation
        gui.setItem(HELP_SLOT, createHelpItem());
        gui.setItem(CLOSE_SLOT, createCloseItem());
    }

    /**
     * Ouvre le menu des r√©compenses de prestige
     */
    public void openRewardsMenu(Player player, int page) {
        Inventory gui = Bukkit.createInventory(null, 54, "¬ß6üì¶ R√©compenses de Prestige ¬ß7(Page " + (page + 1) + ")");

        fillWithGlass(gui);
        setupRewardsMenu(gui, player, page);

        player.openInventory(gui);
        player.playSound(player.getLocation(), Sound.BLOCK_CHEST_OPEN, 1.0f, 1.0f);
    }

    /**
     * Configure le menu des r√©compenses
     */
    private void setupRewardsMenu(Inventory gui, Player player, int page) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        int prestigeLevel = playerData.getPrestigeLevel();

        // Affichage des r√©compenses par tranches de 10 niveaux
        int startLevel = (page * 10) + 1;
        int endLevel = Math.min(startLevel + 9, 50);

        int slot = 10; // Commencer √† la deuxi√®me ligne
        for (int level = startLevel; level <= endLevel && slot < 44; level++) {
            ItemStack rewardItem = createRewardDisplayItem(player, level);
            gui.setItem(slot, rewardItem);

            slot++;
            if (slot % 9 == 8) slot += 2; // √âviter les bords
        }

        // Navigation
        if (page > 0) {
            gui.setItem(45, createPageButton("¬ßa‚¨Ö Page pr√©c√©dente", page - 1, "rewards"));
        }
        if (endLevel < 50) {
            gui.setItem(53, createPageButton("¬ßaPage suivante ‚û°", page + 1, "rewards"));
        }

        gui.setItem(49, createBackToMainButton());
    }

    /**
     * Ouvre le menu des talents de prestige
     */
    public void openTalentsMenu(Player player, int page) {
        Inventory gui = Bukkit.createInventory(null, 54, "¬ß5‚ö° Talents de Prestige");

        fillWithGlass(gui);
        setupTalentsMenu(gui, player);

        player.openInventory(gui);
        player.playSound(player.getLocation(), Sound.BLOCK_ENCHANTMENT_TABLE_USE, 1.0f, 1.2f);
    }

    /**
     * Configure le menu des talents
     */
    private void setupTalentsMenu(Inventory gui, Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        Map<PrestigeTalent, Integer> playerTalents = playerData.getPrestigeTalents();

        // Affichage des 4 talents cycliques
        PrestigeTalent[] talents = PrestigeTalent.values();
        int[] slots = {20, 21, 23, 24}; // 2x2 au centre

        for (int i = 0; i < talents.length && i < slots.length; i++) {
            PrestigeTalent talent = talents[i];
            int currentLevel = playerTalents.getOrDefault(talent, 0);

            gui.setItem(slots[i], createTalentDisplayItem(talent, currentLevel, playerData.getPrestigeLevel()));
        }

        // Informations sur les talents
        gui.setItem(13, createTalentsInfoItem(player));

        // Navigation
        gui.setItem(49, createBackToMainButton());
    }

    /**
     * Ouvre le menu de choix des r√©compenses sp√©ciales
     */
    public void openSpecialRewardsMenu(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        // Trouver le prochain niveau de prestige qui a des r√©compenses √† choisir
        int targetLevel = -1;
        for (int level = 5; level <= playerData.getPrestigeLevel(); level += 5) {
            if (playerData.canChooseRewardForPrestige(level)) {
                targetLevel = level;
                break;
            }
        }

        if (targetLevel == -1) {
            player.sendMessage("¬ßc‚ùå Aucune r√©compense sp√©ciale √† choisir!");
            return;
        }

        List<PrestigeReward> rewards = PrestigeReward.SpecialRewards.getSpecialRewardsForPrestige(targetLevel);
        if (rewards.size() <= 1) {
            player.sendMessage("¬ßc‚ùå Pas de choix disponible pour ce niveau!");
            return;
        }

        Inventory gui = Bukkit.createInventory(null, 27, "¬ß6üéÅ Choisir R√©compense P" + targetLevel);

        fillWithGlass(gui);

        // Afficher les choix
        int[] choiceSlots = {11, 13, 15};
        for (int i = 0; i < rewards.size() && i < choiceSlots.length; i++) {
            ItemStack rewardItem = rewards.get(i).getDisplayItem();
            ItemMeta meta = rewardItem.getItemMeta();
            if (meta != null) {
                meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "choose_reward");
                meta.getPersistentDataContainer().set(rewardIdKey, PersistentDataType.STRING, rewards.get(i).getId());
                meta.getPersistentDataContainer().set(prestigeLevelKey, PersistentDataType.INTEGER, targetLevel);
                rewardItem.setItemMeta(meta);
            }
            gui.setItem(choiceSlots[i], rewardItem);
        }

        // Retour
        gui.setItem(22, createBackToMainButton());

        player.openInventory(gui);
        player.playSound(player.getLocation(), Sound.BLOCK_NOTE_BLOCK_CHIME, 1.0f, 1.0f);
    }

    /**
     * G√®re les clics dans les menus de prestige
     */
    public void handleClick(Player player, ItemStack clickedItem, ClickType clickType) {
        if (clickedItem == null || !clickedItem.hasItemMeta()) return;

        ItemMeta meta = clickedItem.getItemMeta();
        if (!meta.getPersistentDataContainer().has(actionKey, PersistentDataType.STRING)) return;

        String action = meta.getPersistentDataContainer().get(actionKey, PersistentDataType.STRING);

        switch (action) {
            case "open_rewards" -> openRewardsMenu(player, 0);
            case "open_talents" -> openTalentsMenu(player, 0);
            case "perform_prestige" -> {
                player.closeInventory();
                player.performCommand("prestige effectuer");
            }
            case "choose_reward" -> {
                String rewardId = meta.getPersistentDataContainer().get(rewardIdKey, PersistentDataType.STRING);
                int prestigeLevel = meta.getPersistentDataContainer().get(prestigeLevelKey, PersistentDataType.INTEGER);
                handleRewardChoice(player, rewardId, prestigeLevel);
            }
            case "page_navigation" -> {
                // G√©r√© par les donn√©es dans l'item
            }
            case "back_to_main" -> openMainPrestigeMenu(player);
            case "close" -> player.closeInventory();
        }

        player.playSound(player.getLocation(), Sound.UI_BUTTON_CLICK, 0.5f, 1.0f);
    }

    /**
     * G√®re le choix d'une r√©compense sp√©ciale
     */
    private void handleRewardChoice(Player player, String rewardId, int prestigeLevel) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());

        if (!playerData.canChooseRewardForPrestige(prestigeLevel)) {
            player.sendMessage("¬ßc‚ùå Vous ne pouvez plus choisir de r√©compense pour ce niveau!");
            return;
        }

        // Trouver la r√©compense
        List<PrestigeReward> rewards = PrestigeReward.SpecialRewards.getSpecialRewardsForPrestige(prestigeLevel);
        PrestigeReward chosenReward = rewards.stream()
                .filter(reward -> reward.getId().equals(rewardId))
                .findFirst()
                .orElse(null);

        if (chosenReward == null) {
            player.sendMessage("¬ßc‚ùå R√©compense introuvable!");
            return;
        }

        // Donner la r√©compense
        plugin.getPrestigeManager().getRewardManager().giveSpecialReward(player, chosenReward);

        // Marquer comme choisie
        playerData.addChosenSpecialReward(rewardId);

        player.closeInventory();
        player.sendMessage("¬ßa‚úÖ R√©compense choisie: ¬ß6" + chosenReward.getDisplayName());
        player.playSound(player.getLocation(), Sound.ENTITY_PLAYER_LEVELUP, 1.0f, 1.0f);
    }

    // =============== M√âTHODES DE CR√âATION D'ITEMS ===============

    private void fillWithGlass(Inventory gui) {
        ItemStack glass = new ItemStack(Material.BLACK_STAINED_GLASS_PANE);
        ItemMeta glassMeta = glass.getItemMeta();
        if (glassMeta != null) {
            glassMeta.setDisplayName(" ");
            glass.setItemMeta(glassMeta);
        }

        for (int i = 0; i < gui.getSize(); i++) {
            if (gui.getItem(i) == null) {
                gui.setItem(i, glass);
            }
        }
    }

    private ItemStack createPrestigeInfoItem(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        int prestigeLevel = playerData.getPrestigeLevel();

        Material material = prestigeLevel > 0 ? Material.NETHER_STAR : Material.GRAY_DYE;
        ItemStack item = new ItemStack(material);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName("¬ß6üèÜ Votre Prestige");

            List<String> lore = new ArrayList<>();
            lore.add("¬ß7Niveau actuel: " + playerData.getPrestigeDisplayName());
            lore.add("");

            if (prestigeLevel > 0) {
                lore.add("¬ße‚ö° Talents actifs:");
                Map<PrestigeTalent, Integer> talents = playerData.getPrestigeTalents();
                if (talents.isEmpty()) {
                    lore.add("¬ß7  Aucun talent actif");
                } else {
                    for (Map.Entry<PrestigeTalent, Integer> entry : talents.entrySet()) {
                        lore.add("¬ß7  ‚Ä¢ ¬ß6" + entry.getKey().getDisplayName() + " ¬ß7(Niv." + entry.getValue() + ")");
                    }
                }
                lore.add("");
                lore.add("¬ßaüìà Bonus totaux:");
                lore.add("¬ß7  ‚Ä¢ Money Greed: ¬ßa+" + String.format("%.1f", playerData.getPrestigeMoneyGreedBonus() * 100) + "%");
                lore.add("¬ß7  ‚Ä¢ Token Greed: ¬ßa+" + String.format("%.1f", playerData.getPrestigeTokenGreedBonus() * 100) + "%");
                lore.add("¬ß7  ‚Ä¢ R√©duction taxe: ¬ßa-" + String.format("%.1f", playerData.getPrestigeTaxReduction() * 100) + "%");
            } else {
                lore.add("¬ß7Aucun prestige effectu√©");
                lore.add("¬ß7Atteignez le rang ¬ßd¬ßlFREE ¬ß7pour d√©bloquer");
            }

            meta.setLore(lore);
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createRewardsButton() {
        ItemStack item = new ItemStack(Material.CHEST);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName("¬ß6üì¶ R√©compenses de Prestige");
            meta.setLore(List.of(
                    "¬ß7Consultez toutes les r√©compenses",
                    "¬ß7disponibles pour chaque niveau",
                    "¬ß7de prestige.",
                    "",
                    "¬ßeCliquez pour ouvrir!"
            ));
            meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "open_rewards");
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createTalentsButton() {
        ItemStack item = new ItemStack(Material.ENCHANTED_BOOK);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName("¬ß5‚ö° Talents de Prestige");
            meta.setLore(List.of(
                    "¬ß7Visualisez vos talents de prestige",
                    "¬ß7et leurs effets cumul√©s.",
                    "",
                    "¬ß7Les talents se d√©bloquent automatiquement",
                    "¬ß7selon un cycle de 4 niveaux.",
                    "",
                    "¬ßeCliquez pour ouvrir!"
            ));
            meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "open_talents");
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createPerformPrestigeButton(int nextLevel) {
        ItemStack item = new ItemStack(Material.BEACON);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName("¬ßa‚ú® Effectuer Prestige " + nextLevel);
            meta.setLore(List.of(
                    "¬ß7Effectuez votre prochain prestige!",
                    "",
                    "¬ßc‚ö† ATTENTION:",
                    "¬ß7‚Ä¢ Retour au rang A",
                    "¬ß7‚Ä¢ Remise √† 0 des coins",
                    "",
                    "¬ßa‚úÖ AVANTAGES:",
                    "¬ß7‚Ä¢ Talents permanents",
                    "¬ß7‚Ä¢ Mines prestige exclusives",
                    "¬ß7‚Ä¢ R√©compenses sp√©ciales",
                    "",
                    "¬ßeCliquez pour commencer!"
            ));
            meta.addEnchant(Enchantment.UNBREAKING, 1, true);
            meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "perform_prestige");
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createLockedPrestigeButton() {
        ItemStack item = new ItemStack(Material.BARRIER);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName("¬ßcüîí Prestige Verrouill√©");
            meta.setLore(List.of(
                    "¬ß7Conditions non remplies:",
                    "¬ßc‚Ä¢ Rang FREE requis",
                    "¬ßc‚Ä¢ Pas d'√©pargne active",
                    "¬ßc‚Ä¢ Pas d'investissement actif",
                    "¬ßc‚Ä¢ Ne pas √™tre en challenge"
            ));
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createMinesInfoItem(Player player) {
        PlayerData playerData = plugin.getPlayerDataManager().getPlayerData(player.getUniqueId());
        int prestigeLevel = playerData.getPrestigeLevel();

        ItemStack item = new ItemStack(Material.DIAMOND_PICKAXE);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName("¬ßb‚õè Mines Prestige");

            List<String> lore = new ArrayList<>();
            lore.add("¬ß7Mines exclusives aux joueurs prestige");
            lore.add("");

            if (prestigeLevel >= 1) {
                lore.add("¬ßa‚úÖ Mine Prestige I ¬ß7(0.1% beacons)");
            } else {
                lore.add("¬ßcüîí Mine Prestige I ¬ß7(P1+)");
            }

            if (prestigeLevel >= 11) {
                lore.add("¬ßa‚úÖ Mine Prestige XI ¬ß7(0.5% beacons)");
            } else {
                lore.add("¬ßcüîí Mine Prestige XI ¬ß7(P11+)");
            }

            if (prestigeLevel >= 21) {
                lore.add("¬ßa‚úÖ Mine Prestige XXI ¬ß7(1% beacons)");
            } else {
                lore.add("¬ßcüîí Mine Prestige XXI ¬ß7(P21+)");
            }

            if (prestigeLevel >= 31) {
                lore.add("¬ßa‚úÖ Mine Prestige XXXI ¬ß7(3% beacons)");
            } else {
                lore.add("¬ßcüîí Mine Prestige XXXI ¬ß7(P31+)");
            }

            if (prestigeLevel >= 41) {
                lore.add("¬ßa‚úÖ Mine Prestige XLI ¬ß7(5% beacons)");
            } else {
                lore.add("¬ßcüîí Mine Prestige XLI ¬ß7(P41+)");
            }

            meta.setLore(lore);
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createRewardDisplayItem(Player player, int level) {
        // TODO: Cr√©er l'affichage des r√©compenses pour chaque niveau
        ItemStack item = new ItemStack(Material.GOLD_INGOT);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName("¬ß6Prestige " + level);
            // Ajouter les d√©tails des r√©compenses selon le niveau
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createTalentDisplayItem(PrestigeTalent talent, int currentLevel, int prestigeLevel) {
        Material material = switch (talent) {
            case PROFIT_AMELIORE -> Material.GOLD_NUGGET;
            case ECONOMIE_OPTIMISEE -> Material.EMERALD;
            case PROFIT_AMELIORE_II -> Material.GOLD_INGOT;
            case ECONOMIE_OPTIMISEE_II -> Material.DIAMOND;
        };

        ItemStack item = new ItemStack(material);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName("¬ß6" + talent.getDisplayName());

            List<String> lore = new ArrayList<>();
            lore.add("¬ß7" + talent.getDescription().replace("\n", " ¬ß7"));
            lore.add("");
            lore.add("¬ß7Niveau actuel: ¬ße" + currentLevel);
            lore.add("¬ß7Disponible tous les " + talent.getCycle() + " prestiges");

            meta.setLore(lore);
            meta.getPersistentDataContainer().set(talentKey, PersistentDataType.STRING, talent.name());
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createTalentsInfoItem(Player player) {
        ItemStack item = new ItemStack(Material.BOOK);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName("¬ßeüìñ Informations Talents");
            meta.setLore(List.of(
                    "¬ß7Les talents de prestige sont obtenus",
                    "¬ß7automatiquement selon un cycle:",
                    "",
                    "¬ß6P1,6,11,16... ¬ß7Profit Am√©lior√©",
                    "¬ßbP2,7,12,17... ¬ß7√âconomie Optimis√©e",
                    "¬ß6P3,8,13,18... ¬ß7Profit Am√©lior√© II",
                    "¬ßbP4,9,14,19... ¬ß7√âconomie Optimis√©e II",
                    "",
                    "¬ß7Les paliers P5,10,15... donnent",
                    "¬ß7des r√©compenses sp√©ciales √† choisir."
            ));
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createPageButton(String name, int page, String type) {
        ItemStack item = new ItemStack(Material.ARROW);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName(name);
            meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "page_navigation");
            meta.getPersistentDataContainer().set(prestigeLevelKey, PersistentDataType.INTEGER, page);
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createBackToMainButton() {
        ItemStack item = new ItemStack(Material.DARK_OAK_DOOR);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName("¬ß7‚Üê Retour au menu principal");
            meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "back_to_main");
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createHelpItem() {
        ItemStack item = new ItemStack(Material.WRITABLE_BOOK);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName("¬ße‚ùì Aide");
            meta.setLore(List.of(
                    "¬ß7Aide sur le syst√®me de prestige"
            ));
            item.setItemMeta(meta);
        }

        return item;
    }

    private ItemStack createCloseItem() {
        ItemStack item = new ItemStack(Material.BARRIER);
        ItemMeta meta = item.getItemMeta();

        if (meta != null) {
            meta.setDisplayName("¬ßc‚úñ Fermer");
            meta.getPersistentDataContainer().set(actionKey, PersistentDataType.STRING, "close");
            item.setItemMeta(meta);
        }

        return item;
    }
}